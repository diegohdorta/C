---
layout: post
title: "ML Frameworks for iMX8"
author: "Diego Dorta"
categories: artificial
tags: [ ml, machine, learning, code, source, pip, python, libraries, tensorflow, scikitlearn, caffe, scipy, numpy ]
---

Working with `Machine Learning` on `iMX` boards requires to have installed *Python language*,
and its package installer *pip* along with a few libraries which are basically [`numpy`](http://www.numpy.org/) and [`scipy`](https://www.scipy.org/).

Yocto has recipes for *Python*, *pip* and *numpy*. However, it does not have a recipe support for including *scipy* and its dependencies *libatlas-base-dev* (libraries etc. for ATLAS/BLAS) and *gfortran* (GNU Fortran compiler).

Instead of struggling for awhile to create these recipes, a *Debian file system* is used momentarily. The *meta-machinelearning* layer will be created when these dependencies have recipes on Yocto.

For making it easy to develop codes using *ML*, a *Python* library called [`scikit learn`](http://scikit-learn.org/) can help us to get solutions.

## Creating an image

**This post works well for iMX6, iMX7 and iMX8.**

This section assumes you have a basic knowledge on *iMX* systems. The first step consists on creating a image using Yocto:

Create your *core-image-base* using [`meta-fsl-arm`](http://freescale.github.io/#download):

```bash
$ MACHINE=imx6qsabresd DISTRO=fslc-framebuffer source setup-environment build
```
Add the following line in the *bb.layers* of your project:

```bash
${BSPDIR}/sources/meta-openembedded/meta-python/
```

Add the following line which contains the packages to be installed in the *local.conf* file:

```basg
CORE_IMAGE_EXTRA_INSTALL += " python python-pip python-core python-numpy python-distutils "
```
Start the building:

```bash
$ bitbake core-image-base
```
This can take several hours depending on your machine and network speed connection.

Flash the image located on *tmp/deploy/images* folder into the SD card:

```bash
$ gunzip -f core-image-base-imx6qsabresd.sdcard.gz
$ dd if=core-image-base-imx6qsabresd.sdcard of=/dev/sdX status=progress && sync
```
If it had recipes for all the dependencies, then the normal procedure would end here. However a *uglyhack* can solve our problem momentarily. 
The next section changes the *rootfs* for a *Debian* one, including a *package manager* which allows us to install the requires packages for *scikit-learn*.

## Debian File System

*This section is a temporary*. It uses the SD card fully burned from the previoulys step.
The next steps were copied from the post [How to create a Debian image to iMX](https://imxdev.gitlab.io/tutorial/How_to_create_a_Debian_image_to_iMX_6Quad_SABRE-SD/).

Start by installing the required packages to create the file system:

```bash
$ apt-get install debootstrap qemu-user-static
```
Create a folder to mount your SD card and start the installation:

```bash
$ mkdir mounting
$ mount /dev/sd<device>C mounting/
$ debootstrap --foreign --arch=armhf wheezy mounting/
```
In `/dev/sd<device>C` should be your `root` partition, for instance: */dev/sdb2*.

Enable _QEMU ARM_ and _second stage_:

```bash
$ cp /usr/bin/qemu-arm-static mounting/usr/bin/
$ chroot mounting/ /debootstrap/debootstrap --second-stage
```
Add the following line in the file `mounting/etc/inittab`:

```bash
T0:23:respawn:/sbin/getty -L ttymxc0 115200 vt100
```

Add the `eth0` configuration above in the file `mounting/etc/network/interfaces`:

```bash
auto eth0
iface eth0 inet dhcp
```
To enable the system to allow login as root, edit the file `mounting/etc/shadow` changing the first line to be like the following (remove the *):

```bash
 "root:*:15880:0:99999:7:::"
```
Unmount the partition and boot the board:

```bash
$ umount mounting/
```
The following image will show what the above steps have done with the image generated by Yocto.

<center><img src="{{site.url}}{{site.baseurl}}/assets/image.png"/></center>

## iMX* Boards

Run the following commands for installing the required packages:

```bash
$ apt-get update
$ apt-get install gfortran libatlas-base-dev
$ apt-get install python python-pip python-dev
```
Install the packages required by *Machine Learning*:

```bash
$ pip install -U numpy --index-url=https://pypi.python.org/simple/
```
<center><img src="{{site.url}}{{site.baseurl}}/assets/numpy.png"/></center>

```bash
$ pip install -U scipy --index-url=https://pypi.python.org/simple/
```
<center><img src="{{site.url}}{{site.baseurl}}/assets/scipy.png"/></center>

Then, install the _scikit-learn_ library:

```bash
$ pip install -U scikit-learn --index-url=https://pypi.python.org/simple/
```
<center><img src="{{site.url}}{{site.baseurl}}/assets/sklearn.png"/></center>

Your board is configured for running applications using *Machine Learning* libraries.

## Compressing

To compress the image, just run the following command (`root privileges`):

```bash
$ dd if=/dev/sd<device> count=800 bs=1M status=progress | gzip > ml.gz
```
To uncompress the image, just run the following command:

```bash
$ gzip -dc ml.gz | dd of=/dev/sdX status=progress && sync
```

## Image

These steps take a few hours, if you do not have time you can download [here](https://nxp1.sharepoint.com/:u:/s/machinelearningonimxai/EYLlDuJYhf9Gkmhzw-Ze5NgBCbd5BDH7ZsMygNCjR4jstg?e=5HWOO5), and burn it into the SD card as follows:

```bash
$ gzip -dc ml.gz | dd of=/dev/sdX status=progress && sync
```
